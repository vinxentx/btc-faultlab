version: "3.8"
name: "{{ network_name }}"

{% set n = (node_count | int) %}
services:
{% for i in range(1, n + 1) %}
  node{{ "%02d"|format(i) }}:
    image: "{{ image }}"
    container_name: "node{{ "%02d"|format(i) }}"

    restart: unless-stopped
    command: >
      bitcoind -regtest=1 -printtoconsole=1
      -conf=/home/bitcoin/.bitcoin/bitcoin.conf
    volumes:
      - "{{ workdir }}/data/node{{ '%02d'|format(i) }}:/home/bitcoin/.bitcoin"
    networks: [ "{{ network_name }}" ]
{% endfor %}

  txgen:
    image: "python:3.12-slim"
    container_name: "txgen"

    restart: unless-stopped
    working_dir: /app
    volumes:
      - "{{ workdir }}/files:/app:ro"
      - "{{ workdir }}/results:/results"
    command: >
      bash -lc "python -u /app/txgen.py --rate {{ tx_rate }}
      --rpc http://{{ rpc_user }}:{{ rpc_pass }}@node01:18443
      --log /results/txlog.csv"
    depends_on:
      - node01
    networks: [ "{{ network_name }}" ]

networks:
  {{ network_name }}:
    driver: bridge
